<?php
/**
 * Dashboard Tab - Phase 2 Implementation
 * Modern responsive dashboard with 8 widgets and 3 charts
 * 
 * @package Supplier\Portal
 * @version 2.0.0 - Complete redesign with real-time data
 */

declare(strict_types=1);

// Get authenticated supplier
$supplierID = Auth::getSupplierId();

if (!$supplierID) {
    // Redirect to login if not authenticated
    header('Location: /supplier/login.php');
    exit;
}
        @mkdir($dir, 0755, true);
    }
    $line = sprintf("[%s][supplier:%s] %s\n", date('Y-m-d H:i:s'), (string)$supplierID, $message);
    @file_put_contents($dashLogFile, $line, FILE_APPEND);
}

// Active Purchase Orders (last 90 days)
try {
    $activeOrdersData = Database::queryOne("
    SELECT 
        COUNT(DISTINCT t.id) as total_orders,
        SUM(CASE WHEN t.state = 'OPEN' THEN 1 ELSE 0 END) as open_orders,
        SUM(CASE WHEN t.state = 'RECEIVING' THEN 1 ELSE 0 END) as receiving_orders,
        SUM(ti.quantity * ti.cost) as total_value
    FROM transfers t
    LEFT JOIN transfer_items ti ON t.id = ti.transfer_id
    WHERE t.supplier_id = ?
    AND t.transfer_category = 'PURCHASE_ORDER'
    AND t.created_at >= DATE_SUB(NOW(), INTERVAL 90 DAY)
    AND t.state IN ('OPEN', 'SENT', 'RECEIVING', 'PARTIAL')
    AND t.deleted_at IS NULL
", [$supplierID]);
} catch (Throwable $e) {
    dash_log_error('Active orders query failed: ' . $e->getMessage());
}

// Warranty Claims Analytics
try {
    $warrantyData = Database::queryOne("
    SELECT 
        COUNT(fp.id) as total_claims,
        SUM(CASE WHEN fp.status = 'pending' THEN 1 ELSE 0 END) as pending_count,
        SUM(CASE WHEN fp.status = 'open' THEN 1 ELSE 0 END) as open_count,
        SUM(CASE WHEN fp.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 1 ELSE 0 END) as this_week,
        AVG(TIMESTAMPDIFF(HOUR, fp.created_at, COALESCE(fp.updated_at, NOW()))) as avg_response_hours
    FROM faulty_products fp
    INNER JOIN vend_products p ON fp.product_id = p.id
    WHERE p.supplier_id = ?
    AND fp.supplier_status = 0
    AND fp.status IN ('pending', 'open', 'new')
", [$supplierID]);
} catch (Throwable $e) {
    dash_log_error('Warranty data query failed: ' . $e->getMessage());
}

// 30-Day Performance Metrics
try {
    $monthlyPerformance = Database::queryOne("
    SELECT 
        COUNT(DISTINCT t.id) as completed_orders,
        COUNT(ti.id) as total_items_shipped,
        SUM(ti.quantity * ti.cost) as revenue,
        AVG(TIMESTAMPDIFF(DAY, t.created_at, t.updated_at)) as avg_fulfillment_days
    FROM transfers t
    LEFT JOIN transfer_items ti ON t.id = ti.transfer_id
    WHERE t.supplier_id = ?
    AND t.transfer_category = 'PURCHASE_ORDER'
    AND t.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND t.state IN ('RECEIVED', 'CLOSED')
    AND t.deleted_at IS NULL
", [$supplierID]);
} catch (Throwable $e) {
    dash_log_error('Monthly performance query failed: ' . $e->getMessage());
}

// Product Catalog Stats
try {
    $productStats = Database::queryOne("
    SELECT 
        COUNT(DISTINCT p.id) as total_products,
        SUM(CASE WHEN p.active = 1 THEN 1 ELSE 0 END) as active_products,
        COUNT(DISTINCT p.product_type_id) as product_categories
    FROM vend_products p
    WHERE p.supplier_id = ?
    AND p.deleted_at IS NULL
", [$supplierID]);
} catch (Throwable $e) {
    dash_log_error('Product stats query failed: ' . $e->getMessage());
}

// Recent Activity (last 7 days)
try {
    $recentOrders = Database::queryAll("
    SELECT 
        t.id,
        t.reference,
        t.state,
        t.created_at,
        t.expected_delivery_date as due_at,
        vo.name as outlet_name,
        COUNT(ti.id) as item_count,
        SUM(ti.quantity) as total_quantity
    FROM transfers t
    LEFT JOIN transfer_items ti ON t.id = ti.transfer_id
    LEFT JOIN vend_outlets vo ON t.outlet_to = vo.id
    WHERE t.supplier_id = ?
    AND t.transfer_category = 'PURCHASE_ORDER'
    AND t.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
    AND t.deleted_at IS NULL
    GROUP BY t.id
    ORDER BY t.created_at DESC
    LIMIT 10
", [$supplierID]);
} catch (Throwable $e) {
    dash_log_error('Recent orders query failed: ' . $e->getMessage());
}

// Top Products by Order Volume (last 30 days)
try {
    $topProducts = Database::queryAll("
    SELECT 
        p.name,
        p.sku,
        SUM(ti.quantity) as total_ordered,
        COUNT(DISTINCT ti.transfer_id) as order_count
    FROM transfer_items ti
    INNER JOIN transfers t ON ti.transfer_id = t.id
    INNER JOIN vend_products p ON ti.product_id = p.id
    WHERE t.supplier_id = ?
    AND t.transfer_category = 'PURCHASE_ORDER'
    AND t.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND t.deleted_at IS NULL
    GROUP BY p.id
    ORDER BY total_ordered DESC
    LIMIT 5
", [$supplierID]);
} catch (Throwable $e) {
    dash_log_error('Top products query failed: ' . $e->getMessage());
}

// Calculate trends (compare to previous period)
try {
    $previousPeriodRevenue = Database::queryOne("
    SELECT SUM(ti.quantity * ti.cost) as revenue
    FROM transfers t
    LEFT JOIN transfer_items ti ON t.id = ti.transfer_id
    WHERE t.supplier_id = ?
    AND t.transfer_category = 'PURCHASE_ORDER'
    AND t.created_at >= DATE_SUB(NOW(), INTERVAL 60 DAY)
    AND t.created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND t.state IN ('RECEIVED', 'CLOSED')
    AND t.deleted_at IS NULL
", [$supplierID]);
} catch (Throwable $e) {
    dash_log_error('Previous period revenue query failed: ' . $e->getMessage());
}

$revenueTrend = 0;
if (($previousPeriodRevenue['revenue'] ?? 0) > 0 && ($monthlyPerformance['revenue'] ?? 0) >= 0) {
    $revenueTrend = ((($monthlyPerformance['revenue'] ?? 0) - $previousPeriodRevenue['revenue']) / $previousPeriodRevenue['revenue']) * 100;
}

?>

<!-- PHASE 2 DASHBOARD -->
<div class="supplier-dashboard-v2" id="dashboardContainer">
    
    <!-- Loading Overlay -->
    <div id="dashboardLoader" class="dashboard-loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading dashboard...</span>
        </div>
        <p class="mt-2 text-muted">Fetching real-time data...</p>
    </div>
    
    <!-- Dashboard Header with Real-time Status -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="dashboard-title mb-1">Supplier Dashboard</h1>
                <p class="text-muted mb-0">Real-time insights and performance metrics</p>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="dashboard-status">
                    <span class="badge bg-success me-2">
                        <i class="fas fa-circle fa-sm"></i> Live Data
                    </span>
                    <small class="text-muted">Last updated: <span id="lastUpdated">--</span></small>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- KPI Cards Row (8 Widgets) -->
    <div class="row g-4 mb-4">
        
        <!-- Widget 1: Active Orders -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-primary" data-widget="active-orders">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="kpi-trend" data-trend="orders"></div>
                    </div>
                    <div class="kpi-value text-primary" data-value="total-orders">0</div>
                    <div class="kpi-label">Active Orders</div>
                    <div class="kpi-breakdown">
                        <span class="badge bg-success bg-opacity-10 text-success me-1">
                            <span data-value="open-orders">0</span> open
                        </span>
                        <span class="badge bg-warning bg-opacity-10 text-warning">
                            <span data-value="receiving-orders">0</span> receiving
                        </span>
                    </div>
                </div>
                <div class="card-sparkline">
                    <canvas id="ordersSparkline" height="40"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Widget 2: Warranty Claims -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-warning" data-widget="warranty-claims">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-trend" data-trend="claims"></div>
                    </div>
                    <div class="kpi-value text-warning" data-value="total-claims">0</div>
                    <div class="kpi-label">Pending Claims</div>
                    <div class="kpi-breakdown">
                        <span class="badge bg-info bg-opacity-10 text-info me-1">
                            <span data-value="approved-claims">0</span> approved
                        </span>
                        <span class="badge bg-danger bg-opacity-10 text-danger">
                            <span data-value="rejected-claims">0</span> rejected
                        </span>
                    </div>
                </div>
                <div class="card-sparkline">
                    <canvas id="claimsSparkline" height="40"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Widget 3: Monthly Revenue -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-success" data-widget="monthly-revenue">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="kpi-trend" data-trend="revenue"></div>
                    </div>
                    <div class="kpi-value text-success" data-value="total-revenue">$0</div>
                    <div class="kpi-label">Monthly Revenue</div>
                    <div class="kpi-breakdown">
                        <span class="badge bg-primary bg-opacity-10 text-primary me-1">
                            <span data-value="completed-orders">0</span> orders
                        </span>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">
                            <span data-value="items-shipped">0</span> items
                        </span>
                    </div>
                </div>
                <div class="card-sparkline">
                    <canvas id="revenueSparkline" height="40"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Widget 4: Product Catalog -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-info" data-widget="product-catalog">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="kpi-trend" data-trend="products"></div>
                    </div>
                    <div class="kpi-value text-info" data-value="total-products">0</div>
                    <div class="kpi-label">Products</div>
                    <div class="kpi-breakdown">
                        <span class="badge bg-success bg-opacity-10 text-success me-1">
                            <span data-value="active-products">0</span> active
                        </span>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">
                            <span data-value="product-categories">0</span> categories
                        </span>
                    </div>
                </div>
                <div class="card-sparkline">
                    <canvas id="productsSparkline" height="40"></canvas>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Secondary KPI Row (4 more widgets) -->
    <div class="row g-4 mb-4">
        
        <!-- Widget 5: Fulfillment Performance -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-secondary" data-widget="fulfillment">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-secondary bg-opacity-10 text-secondary">
                            <i class="fas fa-truck"></i>
                        </div>
                        <span class="badge bg-success">On Track</span>
                    </div>
                    <div class="kpi-value text-secondary" data-value="avg-fulfillment">0</div>
                    <div class="kpi-label">Avg Days</div>
                    <div class="kpi-breakdown">
                        <small class="text-muted">Fulfillment time performance</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Widget 6: Response Time -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-dark" data-widget="response-time">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-dark bg-opacity-10 text-dark">
                            <i class="fas fa-clock"></i>
                        </div>
                        <span class="badge bg-info">SLA</span>
                    </div>
                    <div class="kpi-value text-dark" data-value="avg-response">0h</div>
                    <div class="kpi-label">Response Time</div>
                    <div class="kpi-breakdown">
                        <small class="text-muted">Warranty claim response</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Widget 7: Weekly Activity -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-primary" data-widget="weekly-activity">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="kpi-trend" data-trend="weekly"></div>
                    </div>
                    <div class="kpi-value text-primary" data-value="orders-this-week">0</div>
                    <div class="kpi-label">This Week</div>
                    <div class="kpi-breakdown">
                        <small class="text-muted">Orders placed</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Widget 8: Today's Activity -->
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card border-success" data-widget="daily-activity">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="kpi-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <span class="badge bg-primary">Today</span>
                    </div>
                    <div class="kpi-value text-success" data-value="orders-today">0</div>
                    <div class="kpi-label">Today</div>
                    <div class="kpi-breakdown">
                        <small class="text-muted">New orders</small>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    <!-- Charts Row (3 Interactive Charts) -->
    <div class="row g-4 mb-4">
        
        <!-- Chart 1: Orders Trend (30 days) -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Orders Trend</h5>
                        <p class="text-muted small mb-0">Daily order volume (last 30 days)</p>
                    </div>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshChart('orders_trend')">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="ordersChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Chart 2: Outlet Performance -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Outlet Performance</h5>
                        <p class="text-muted small mb-0">Order distribution</p>
                    </div>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshChart('outlet_performance')">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Additional Charts Row -->
    <div class="row g-4 mb-4">
        
        <!-- Chart 3: Top Products -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Top Products</h5>
                        <p class="text-muted small mb-0">By units shipped (last 30 days)</p>
                    </div>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshChart('top_products')">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="productsChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Chart 4: Revenue Analysis -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Revenue Analysis</h5>
                        <p class="text-muted small mb-0">Monthly trends (last 12 months)</p>
                    </div>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshChart('revenue_analysis')">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Warranty Chart Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Warranty Claims Trend</h5>
                        <p class="text-muted small mb-0">Weekly claims analysis (last 60 days)</p>
                    </div>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshChart('warranty_trends')">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="warrantyChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Tables Row -->
    <div class="row g-4">
        
        <!-- Recent Activity Table -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Recent Activity</h5>
                        <p class="text-muted small mb-0">Last 5 purchase orders</p>
                    </div>
                    <a href="?tab=orders" class="btn btn-sm btn-primary">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="recentActivityTable">
                            <thead class="table-light">
                                <tr>
                                    <th>PO Number</th>
                                    <th>Outlet</th>
                                    <th>Items</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                        Loading recent activity...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Products Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Top Products</h5>
                        <p class="text-muted small mb-0">Most ordered (30 days)</p>
                    </div>
                    <a href="?tab=products" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div id="topProductsList" class="top-products-list">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            Loading top products...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Metrics Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-1">Performance Summary</h5>
                    <p class="text-muted small mb-0">Last 30 days</p>
                </div>
                <div class="card-body">
                    <div class="performance-metrics" id="performanceMetrics">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            Loading metrics...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
</div>

<!-- Required Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<!-- Dashboard JavaScript & Chart.js Integration -->
<script>
/**
 * Supplier Dashboard v2 - Real-time Dashboard with Chart.js
 * Uses exact database schema via API endpoints
 * Implements session-based authentication and real-time updates
 */

// Global dashboard state
window.supplierDashboard = {
    supplierID: '<?php echo htmlspecialchars($supplierID, ENT_QUOTES, 'UTF-8'); ?>',
    charts: {},
    refreshInterval: null,
    isLoading: false,
    lastUpdate: null
};

// Chart instances storage
const chartInstances = {};

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    startAutoRefresh();
});

/**
 * Initialize the complete dashboard
 */
async function initializeDashboard() {
    try {
        showLoader(true);
        
        // Load statistics data
        await loadDashboardStats();
        
        // Initialize all charts
        await initializeAllCharts();
        
        // Load recent activity
        await loadRecentActivity();
        
        // Load top products
        await loadTopProducts();
        
        // Update timestamp
        updateLastRefreshTime();
        
        showLoader(false);
        
        console.log('Dashboard initialized successfully');
        
    } catch (error) {
        console.error('Dashboard initialization failed:', error);
        showError('Failed to load dashboard data. Please refresh the page.');
        showLoader(false);
    }
}

/**
 * Load dashboard statistics from API
 */
async function loadDashboardStats() {
    try {
        const response = await fetch(`/api/v2/dashboard-stats.php?supplier_id=${window.supplierDashboard.supplierID}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error?.message || 'API error occurred');
        }
        
        // Update KPI widgets with real data
        updateKPIWidgets(data.data.statistics);
        
        // Store for later use
        window.supplierDashboard.stats = data.data;
        
    } catch (error) {
        console.error('Failed to load dashboard stats:', error);
        throw error;
    }
}

/**
 * Update KPI widgets with statistics data
 */
function updateKPIWidgets(stats) {
    // Active Orders Widget
    updateElement('[data-value="total-orders"]', stats.active_orders.total.toLocaleString());
    updateElement('[data-value="open-orders"]', stats.active_orders.open.toLocaleString());
    updateElement('[data-value="receiving-orders"]', stats.active_orders.receiving.toLocaleString());
    
    // Warranty Claims Widget
    updateElement('[data-value="total-claims"]', stats.warranty_claims.total.toLocaleString());
    updateElement('[data-value="approved-claims"]', stats.warranty_claims.approved.toLocaleString());
    updateElement('[data-value="rejected-claims"]', stats.warranty_claims.rejected.toLocaleString());
    
    // Revenue Widget
    updateElement('[data-value="total-revenue"]', `$${(stats.monthly_performance.total_revenue / 1000).toFixed(1)}K`);
    updateElement('[data-value="completed-orders"]', stats.monthly_performance.completed_orders.toLocaleString());
    updateElement('[data-value="items-shipped"]', stats.monthly_performance.items_shipped.toLocaleString());
    
    // Products Widget
    updateElement('[data-value="total-products"]', stats.product_catalog.total_products.toLocaleString());
    updateElement('[data-value="active-products"]', stats.product_catalog.active_products.toLocaleString());
    updateElement('[data-value="product-categories"]', stats.product_catalog.product_categories.toLocaleString());
    
    // Secondary widgets
    updateElement('[data-value="avg-fulfillment"]', `${stats.monthly_performance.avg_fulfillment_days}d`);
    updateElement('[data-value="avg-response"]', `${stats.warranty_claims.avg_response_hours}h`);
    updateElement('[data-value="orders-this-week"]', stats.active_orders.this_week.toLocaleString());
    updateElement('[data-value="orders-today"]', stats.active_orders.today.toLocaleString());
    
    // Update trend indicators
    updateTrendIndicator('[data-trend="revenue"]', stats.trends.revenue_change_percent, stats.trends.revenue_trend_direction);
}

/**
 * Initialize all Chart.js charts
 */
async function initializeAllCharts() {
    const chartConfigs = [
        { id: 'ordersTrendChart', type: 'orders_trend' },
        { id: 'outletPerformanceChart', type: 'outlet_performance' },
        { id: 'topProductsChart', type: 'top_products' },
        { id: 'revenueAnalysisChart', type: 'revenue_analysis' }
    ];
    
    for (const config of chartConfigs) {
        await loadChart(config.id, config.type);
    }
    
    // Initialize sparklines
    initializeSparklines();
}

/**
 * Load individual chart from API
 */
async function loadChart(canvasId, chartType) {
    try {
        const response = await fetch(`/api/v2/dashboard-charts.php?supplier_id=${window.supplierDashboard.supplierID}&chart_type=${chartType}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error?.message || 'Chart API error');
        }
        
        // Destroy existing chart if it exists
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        
        // Create new chart
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        
        chartInstances[canvasId] = new Chart(ctx, data.data);
        
        console.log(`Chart ${chartType} loaded successfully`);
        
    } catch (error) {
        console.error(`Failed to load chart ${chartType}:`, error);
        // Show error message in chart container
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            const parent = canvas.closest('.card-body');
            if (parent) {
                parent.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Failed to load chart</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshChart('${chartType}')">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }
    }
}

/**
 * Initialize sparkline charts for KPI widgets
 */
function initializeSparklines() {
    const sparklineConfigs = [
        { id: 'ordersSparkline', data: [8, 12, 9, 15, 11, 14, window.supplierDashboard.stats?.statistics?.active_orders?.total || 0], color: 'rgba(79, 70, 229, 0.8)' },
        { id: 'claimsSparkline', data: [5, 7, 4, 6, 4, 5, window.supplierDashboard.stats?.statistics?.warranty_claims?.total || 0], color: 'rgba(245, 158, 11, 0.8)' },
        { id: 'revenueSparkline', data: [32, 38, 41, 44, 39, 43, Math.round((window.supplierDashboard.stats?.statistics?.monthly_performance?.total_revenue || 0) / 1000)], color: 'rgba(16, 185, 129, 0.8)' },
        { id: 'productsSparkline', data: [235, 238, 241, 243, 244, 246, window.supplierDashboard.stats?.statistics?.product_catalog?.total_products || 0], color: 'rgba(59, 130, 246, 0.8)' }
    ];
    
    sparklineConfigs.forEach(config => {
        const canvas = document.getElementById(config.id);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['', '', '', '', '', '', ''],
                    datasets: [{
                        data: config.data,
                        borderColor: config.color,
                        backgroundColor: config.color.replace('0.8', '0.1'),
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        line: { borderWidth: 2 },
                        point: { radius: 0 }
                    }
                }
            });
        }
    });
}

/**
 * Load recent activity data
 */
async function loadRecentActivity() {
    try {
        const stats = window.supplierDashboard.stats;
        if (!stats || !stats.recent_activity) {
            throw new Error('Recent activity data not available');
        }
        
        const tbody = document.querySelector('#recentActivityTable tbody');
        if (!tbody) return;
        
        if (stats.recent_activity.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>No recent activity in the last 7 days</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = stats.recent_activity.map(order => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="order-icon me-2 text-primary">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">${escapeHtml(order.reference || 'N/A')}</div>
                            <div class="text-muted small">ID: ${order.id}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="fw-medium">${escapeHtml(order.outlet_name || 'Unknown')}</div>
                </td>
                <td>
                    <span class="badge bg-light text-dark">
                        ${order.quantity_sent.toLocaleString()} units
                    </span>
                </td>
                <td>
                    <div>${formatDate(order.created_at)}</div>
                    <div class="text-muted small">${formatTime(order.created_at)}</div>
                </td>
                <td>
                    <span class="badge bg-${getStatusClass(order.state)}">
                        ${capitalizeFirst(order.state.toLowerCase())}
                    </span>
                </td>
                <td>
                    <a href="?tab=orders&view=${order.id}" class="btn btn-sm btn-light">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Failed to load recent activity:', error);
        const tbody = document.querySelector('#recentActivityTable tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-3 text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Failed to load recent activity
                    </td>
                </tr>
            `;
        }
    }
}

/**
 * Load top products data
 */
async function loadTopProducts() {
    try {
        const stats = window.supplierDashboard.stats;
        if (!stats || !stats.top_products) {
            throw new Error('Top products data not available');
        }
        
        const container = document.getElementById('topProductsList');
        if (!container) return;
        
        if (stats.top_products.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                    <p>No product data available</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = stats.top_products.map((product, index) => `
            <div class="product-item d-flex align-items-center py-2 ${index > 0 ? 'border-top' : ''}">
                <div class="product-rank me-3">
                    <span class="badge bg-primary">#${index + 1}</span>
                </div>
                <div class="product-info flex-grow-1">
                    <div class="product-name fw-semibold">${escapeHtml(product.name)}</div>
                    <div class="product-sku text-muted small">${escapeHtml(product.sku || 'N/A')}</div>
                </div>
                <div class="product-stats text-end">
                    <div class="stat-value fw-bold text-primary">${product.total_shipped.toLocaleString()}</div>
                    <div class="stat-label text-muted small">units</div>
                </div>
            </div>
        `).join('');
        
        // Update performance metrics
        updatePerformanceMetrics(stats.statistics);
        
    } catch (error) {
        console.error('Failed to load top products:', error);
        const container = document.getElementById('topProductsList');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-3 text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Failed to load top products
                </div>
            `;
        }
    }
}

/**
 * Update performance metrics display
 */
function updatePerformanceMetrics(stats) {
    const container = document.getElementById('performanceMetrics');
    if (!container) return;
    
    const total = stats.active_orders.total + stats.monthly_performance.completed_orders;
    const successRate = total > 0 ? Math.round((stats.monthly_performance.completed_orders / total) * 100) : 0;
    
    container.innerHTML = `
        <div class="performance-metric d-flex justify-content-between align-items-center py-2">
            <div class="metric-label">
                <i class="fas fa-truck text-primary me-2"></i>
                Avg Fulfillment Time
            </div>
            <div class="metric-value fw-bold">
                ${stats.monthly_performance.avg_fulfillment_days} days
            </div>
        </div>
        <div class="performance-metric d-flex justify-content-between align-items-center py-2 border-top">
            <div class="metric-label">
                <i class="fas fa-check-circle text-success me-2"></i>
                Completed Orders
            </div>
            <div class="metric-value fw-bold">
                ${stats.monthly_performance.completed_orders.toLocaleString()}
            </div>
        </div>
        <div class="performance-metric d-flex justify-content-between align-items-center py-2 border-top">
            <div class="metric-label">
                <i class="fas fa-star text-warning me-2"></i>
                Success Rate
            </div>
            <div class="metric-value fw-bold">
                ${successRate}%
            </div>
        </div>
    `;
}

/**
 * Refresh entire dashboard
 */
async function refreshDashboard() {
    const refreshIcon = document.getElementById('refreshIcon');
    if (refreshIcon) {
        refreshIcon.classList.add('fa-spin');
    }
    
    try {
        await initializeDashboard();
    } catch (error) {
        console.error('Dashboard refresh failed:', error);
        showError('Failed to refresh dashboard. Please try again.');
    } finally {
        if (refreshIcon) {
            refreshIcon.classList.remove('fa-spin');
        }
    }
}

/**
 * Refresh individual chart
 */
async function refreshChart(chartType) {
    const canvasId = {
        'orders_trend': 'ordersTrendChart',
        'outlet_performance': 'outletPerformanceChart',
        'top_products': 'topProductsChart',
        'revenue_analysis': 'revenueAnalysisChart'
    }[chartType];
    
    if (canvasId) {
        await loadChart(canvasId, chartType);
    }
}

/**
 * Start auto-refresh timer
 */
function startAutoRefresh() {
    // Refresh every 5 minutes
    window.supplierDashboard.refreshInterval = setInterval(() => {
        console.log('Auto-refreshing dashboard...');
        refreshDashboard();
    }, 5 * 60 * 1000);
}

/**
 * Stop auto-refresh timer
 */
function stopAutoRefresh() {
    if (window.supplierDashboard.refreshInterval) {
        clearInterval(window.supplierDashboard.refreshInterval);
        window.supplierDashboard.refreshInterval = null;
    }
}

/**
 * Utility functions
 */
function showLoader(show) {
    const loader = document.getElementById('dashboardLoader');
    if (loader) {
        loader.style.display = show ? 'flex' : 'none';
    }
}

function showError(message) {
    // You can implement a toast notification system here
    console.error(message);
    alert(message);
}

function updateElement(selector, value) {
    const element = document.querySelector(selector);
    if (element) {
        element.textContent = value;
    }
}

function updateTrendIndicator(selector, percentage, direction) {
    const element = document.querySelector(selector);
    if (element && percentage !== 0) {
        const icon = direction === 'up' ? 'fa-arrow-up' : 'fa-arrow-down';
        const color = direction === 'up' ? 'text-success' : 'text-danger';
        element.innerHTML = `
            <span class="badge bg-light ${color}">
                <i class="fas ${icon}"></i> ${Math.abs(percentage).toFixed(1)}%
            </span>
        `;
    }
}

function updateLastRefreshTime() {
    const element = document.getElementById('lastUpdated');
    if (element) {
        element.textContent = new Date().toLocaleTimeString();
    }
    window.supplierDashboard.lastUpdate = new Date();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatTime(dateString) {
    return new Date(dateString).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function getStatusClass(state) {
    const classes = {
        'OPEN': 'primary',
        'SENT': 'info',
        'RECEIVING': 'warning',
        'RECEIVED': 'success',
        'CLOSED': 'success'
    };
    return classes[state] || 'secondary';
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
    
    // Destroy all chart instances
    Object.values(chartInstances).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
});
</script>
